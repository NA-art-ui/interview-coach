mport React, { useState, useEffect, useRef } from 'react';
import { Mic, MicOff, Play, Pause, Code, Send, BarChart3, User, Briefcase, Brain, Award, CheckCircle, XCircle, Volume2 } from 'lucide-react';

const InterviewCoach = () => {
  const [currentView, setCurrentView] = useState('home');
  const [selectedRole, setSelectedRole] = useState(null);
  const [isListening, setIsListening] = useState(false);
  const [isSpeaking, setIsSpeaking] = useState(false);
  const [transcript, setTranscript] = useState('');
  const [conversation, setConversation] = useState([]);
  const [currentQuestion, setCurrentQuestion] = useState('');
  const [voiceConfidence, setVoiceConfidence] = useState(null);
  const [interviewScore, setInterviewScore] = useState({ technical: 0, behavioral: 0, communication: 0 });
  const [codeEditorOpen, setCodeEditorOpen] = useState(false);
  const [code, setCode] = useState('// Write your code here\n');
  const [codeOutput, setCodeOutput] = useState('');
  const [codeLanguage, setCodeLanguage] = useState('javascript');
  const [interviewPhase, setInterviewPhase] = useState('intro'); // intro, questions, coding, feedback
  const [questionCount, setQuestionCount] = useState(0);
  const [isProcessing, setIsProcessing] = useState(false);
  const [interviewHistory, setInterviewHistory] = useState([]);

  const recognitionRef = useRef(null);
  const synthesisRef = useRef(null);
  const audioContextRef = useRef(null);
  const analyserRef = useRef(null);

  const roles = [
    { id: 'software-engineer', name: 'Software Engineer', icon: 'üíª', color: 'bg-blue-500', skills: ['Data Structures', 'Algorithms', 'System Design', 'Coding'] },
    { id: 'data-scientist', name: 'Data Scientist', icon: 'üìä', color: 'bg-green-500', skills: ['Statistics', 'Machine Learning', 'Python', 'SQL'] },
    { id: 'product-manager', name: 'Product Manager', icon: 'üéØ', color: 'bg-purple-500', skills: ['Strategy', 'Roadmapping', 'User Research', 'Metrics'] },
    { id: 'frontend-developer', name: 'Frontend Developer', icon: 'üé®', color: 'bg-pink-500', skills: ['React', 'CSS', 'JavaScript', 'UX'] },
    { id: 'backend-developer', name: 'Backend Developer', icon: '‚öôÔ∏è', color: 'bg-indigo-500', skills: ['APIs', 'Databases', 'Security', 'Scalability'] },
    { id: 'devops-engineer', name: 'DevOps Engineer', icon: 'üîß', color: 'bg-orange-500', skills: ['CI/CD', 'Cloud', 'Kubernetes', 'Monitoring'] },
    { id: 'ml-engineer', name: 'ML Engineer', icon: 'ü§ñ', color: 'bg-teal-500', skills: ['Deep Learning', 'MLOps', 'PyTorch', 'Model Deployment'] },
    { id: 'ui-ux-designer', name: 'UI/UX Designer', icon: '‚ú®', color: 'bg-yellow-500', skills: ['Figma', 'User Testing', 'Design Systems', 'Prototyping'] }
  ];

  useEffect(() => {
    // Initialize speech recognition
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognitionRef.current = new SpeechRecognition();
      recognitionRef.current.continuous = true;
      recognitionRef.current.interimResults = true;

      recognitionRef.current.onresult = (event) => {
        const current = event.resultIndex;
        const transcript = event.results[current][0].transcript;
        setTranscript(transcript);
        
        if (event.results[current].isFinal) {
          analyzeVoiceConfidence(event.results[current][0]);
        }
      };

      recognitionRef.current.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        setIsListening(false);
      };
    }

    // Initialize audio context for voice analysis
    if ('AudioContext' in window || 'webkitAudioContext' in window) {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      audioContextRef.current = new AudioContext();
      analyserRef.current = audioContextRef.current.createAnalyser();
    }

    // Load interview history from storage
    loadInterviewHistory();

    return () => {
      if (recognitionRef.current) {
        recognitionRef.current.stop();
      }
    };
  }, []);

  const loadInterviewHistory = async () => {
    try {
      const result = await window.storage.get('interview-history');
      if (result && result.value) {
        setInterviewHistory(JSON.parse(result.value));
      }
    } catch (error) {
      console.log('No previous interview history');
    }
  };

  const saveInterviewHistory = async (interview) => {
    try {
      const history = [...interviewHistory, interview];
      await window.storage.set('interview-history', JSON.stringify(history));
      setInterviewHistory(history);
    } catch (error) {
      console.error('Failed to save interview history:', error);
    }
  };

  const analyzeVoiceConfidence = (result) => {
    const confidence = result.confidence || 0.85;
    const wordCount = result.transcript.split(' ').length;
    const pace = wordCount > 15 ? (wordCount > 30 ? 'fast' : 'good') : 'slow';
    
    setVoiceConfidence({
      clarity: (confidence * 100).toFixed(0),
      pace: pace,
      wordCount: wordCount,
      confidenceScore: ((confidence * 0.7 + (wordCount > 10 ? 0.3 : 0.15)) * 100).toFixed(0)
    });
  };

  const startListening = async () => {
    try {
      if (recognitionRef.current) {
        setTranscript('');
        await recognitionRef.current.start();
        setIsListening(true);
      }
    } catch (error) {
      console.error('Failed to start listening:', error);
    }
  };

  const stopListening = () => {
    if (recognitionRef.current) {
      recognitionRef.current.stop();
      setIsListening(false);
    }
  };

  const speak = (text) => {
    return new Promise((resolve) => {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 0.95;
        utterance.pitch = 1;
        utterance.volume = 1;
        
        utterance.onstart = () => setIsSpeaking(true);
        utterance.onend = () => {
          setIsSpeaking(false);
          resolve();
        };
        
        window.speechSynthesis.speak(utterance);
      } else {
        resolve();
      }
    });
  };

  const getAIResponse = async (userMessage, context) => {
    setIsProcessing(true);
    try {
      const systemPrompt = `You are an expert interview coach for ${selectedRole?.name || 'various tech roles'}. 
      Current phase: ${interviewPhase}
      Question count: ${questionCount}/5
      
      Conduct a realistic interview with:
      - Modern, relevant questions (2024-2026 trends)
      - Role-specific technical and behavioral questions
      - Follow-up questions based on answers
      - Constructive feedback
      
      Keep responses concise (2-3 sentences for questions, brief feedback).
      ${interviewPhase === 'coding' ? 'Ask a coding problem appropriate for the role.' : ''}`;

      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 1000,
          messages: [
            ...context,
            { role: 'user', content: userMessage }
          ],
          system: systemPrompt
        })
      });

      const data = await response.json();
      const aiMessage = data.content[0].text;
      
      return aiMessage;
    } catch (error) {
      console.error('AI response error:', error);
      return "I apologize, but I'm having trouble connecting. Please try again.";
    } finally {
      setIsProcessing(false);
    }
  };

  const handleSendMessage = async () => {
    if (!transcript.trim() || isProcessing) return;

    const userMessage = transcript;
    setTranscript('');
    
    const newConversation = [
      ...conversation,
      { role: 'user', content: userMessage, confidence: voiceConfidence }
    ];
    setConversation(newConversation);

    // Calculate scores based on response
    updateScores(userMessage, voiceConfidence);

    // Get AI response
    const aiResponse = await getAIResponse(userMessage, newConversation);
    
    const updatedConversation = [
      ...newConversation,
      { role: 'assistant', content: aiResponse }
    ];
    setConversation(updatedConversation);
    setCurrentQuestion(aiResponse);

    // Speak the response
    await speak(aiResponse);

    // Progress interview
    const newCount = questionCount + 1;
    setQuestionCount(newCount);

    if (newCount === 3 && interviewPhase === 'questions') {
      setInterviewPhase('coding');
      setTimeout(() => {
        const codingPrompt = "Now let's move to a coding challenge. I'll ask you to solve a problem.";
        speak(codingPrompt);
      }, 1000);
    } else if (newCount === 5) {
      setInterviewPhase('feedback');
      provideFinalFeedback();
    }
  };

  const updateScores = (message, confidence) => {
    const words = message.split(' ').length;
    const hasKeywords = /experience|project|implemented|designed|built|developed/i.test(message);
    
    setInterviewScore(prev => ({
      technical: Math.min(100, prev.technical + (hasKeywords ? 15 : 5)),
      behavioral: Math.min(100, prev.behavioral + (words > 20 ? 12 : 6)),
      communication: Math.min(100, prev.communication + (confidence?.confidenceScore > 70 ? 10 : 5))
    }));
  };

  const runCode = async () => {
    setCodeOutput('Running code...');
    
    try {
      if (codeLanguage === 'javascript') {
        // Simple JavaScript execution
        const output = [];
        const originalLog = console.log;
        console.log = (...args) => output.push(args.join(' '));
        
        try {
          const result = eval(code);
          console.log = originalLog;
          setCodeOutput(output.length > 0 ? output.join('\n') : String(result));
          
          // Score the code
          const codeScore = analyzeCode(code);
          setInterviewScore(prev => ({
            ...prev,
            technical: Math.min(100, prev.technical + codeScore)
          }));
        } catch (error) {
          console.log = originalLog;
          setCodeOutput(`Error: ${error.message}`);
        }
      } else if (codeLanguage === 'python') {
        setCodeOutput('Python execution would require a backend. For now, checking syntax...');
        const hasDefKeyword = /def\s+\w+/.test(code);
        const hasReturnKeyword = /return/.test(code);
        if (hasDefKeyword && hasReturnKeyword) {
          setCodeOutput('‚úì Code structure looks good! (Actual execution requires backend)');
          setInterviewScore(prev => ({
            ...prev,
            technical: Math.min(100, prev.technical + 15)
          }));
        }
      }
    } catch (error) {
      setCodeOutput(`Error: ${error.message}`);
    }
  };

  const analyzeCode = (code) => {
    let score = 0;
    
    // Check for good practices
    if (code.includes('function') || code.includes('=>')) score += 10;
    if (code.includes('const') || code.includes('let')) score += 5;
    if (code.includes('return')) score += 10;
    if (code.length > 50) score += 5;
    if (/\/\/.+/.test(code)) score += 5; // Has comments
    
    return score;
  };

  const provideFinalFeedback = async () => {
    const avgScore = (interviewScore.technical + interviewScore.behavioral + interviewScore.communication) / 3;
    
    const feedback = `Interview Complete! Here's your performance:
    
Technical: ${interviewScore.technical}/100
Behavioral: ${interviewScore.behavioral}/100  
Communication: ${interviewScore.communication}/100
Overall: ${avgScore.toFixed(0)}/100

${avgScore >= 80 ? 'üåü Excellent performance! You demonstrated strong skills.' :
  avgScore >= 60 ? 'üëç Good job! Focus on providing more detailed answers.' :
  'üí™ Keep practicing! Work on technical depth and communication.'}`;

    setCurrentQuestion(feedback);
    await speak(feedback);

    // Save to history
    await saveInterviewHistory({
      role: selectedRole.name,
      date: new Date().toISOString(),
      scores: interviewScore,
      overall: avgScore.toFixed(0)
    });
  };

  const startInterview = async (role) => {
    setSelectedRole(role);
    setCurrentView('interview');
    setConversation([]);
    setQuestionCount(0);
    setInterviewPhase('intro');
    setInterviewScore({ technical: 0, behavioral: 0, communication: 0 });
    
    const greeting = `Welcome to your ${role.name} interview. I'll be assessing your technical skills, problem-solving ability, and communication. Let's start with: Tell me about your recent experience with ${role.skills[0]}.`;
    
    setCurrentQuestion(greeting);
    setConversation([{ role: 'assistant', content: greeting }]);
    await speak(greeting);
  };

  // Home View
  if (currentView === 'home') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50 p-4">
        <div className="max-w-6xl mx-auto">
          {/* Header */}
          <div className="text-center mb-8 pt-8">
            <div className="inline-block p-3 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl mb-4">
              <Briefcase className="w-12 h-12 text-white" />
            </div>
            <h1 className="text-4xl font-bold text-gray-900 mb-2">AI Interview Coach</h1>
            <p className="text-lg text-gray-600">Master your interviews with AI-powered practice</p>
          </div>

          {/* Features */}
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <Mic className="w-8 h-8 text-indigo-600 mb-2" />
              <h3 className="font-semibold text-gray-900 mb-1">Voice AI</h3>
              <p className="text-sm text-gray-600">Real-time voice interaction</p>
            </div>
            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <BarChart3 className="w-8 h-8 text-purple-600 mb-2" />
              <h3 className="font-semibold text-gray-900 mb-1">Confidence Analysis</h3>
              <p className="text-sm text-gray-600">Track your speaking patterns</p>
            </div>
            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <Code className="w-8 h-8 text-green-600 mb-2" />
              <h3 className="font-semibold text-gray-900 mb-1">Live Coding</h3>
              <p className="text-sm text-gray-600">Solve problems in real-time</p>
            </div>
            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <Award className="w-8 h-8 text-orange-600 mb-2" />
              <h3 className="font-semibold text-gray-900 mb-1">Detailed Scoring</h3>
              <p className="text-sm text-gray-600">Get instant feedback</p>
            </div>
          </div>

          {/* Role Selection */}
          <div className="mb-8">
            <h2 className="text-2xl font-bold text-gray-900 mb-4">Choose Your Role</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              {roles.map(role => (
                <button
                  key={role.id}
                  onClick={() => startInterview(role)}
                  className="bg-white p-6 rounded-xl shadow-sm border-2 border-gray-100 hover:border-indigo-600 hover:shadow-md transition-all text-left group"
                >
                  <div className={`inline-block p-3 ${role.color} rounded-lg mb-3 text-2xl`}>
                    {role.icon}
                  </div>
                  <h3 className="font-bold text-gray-900 mb-2 group-hover:text-indigo-600">
                    {role.name}
                  </h3>
                  <div className="flex flex-wrap gap-1">
                    {role.skills.slice(0, 3).map((skill, idx) => (
                      <span key={idx} className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">
                        {skill}
                      </span>
                    ))}
                  </div>
                </button>
              ))}
            </div>
          </div>

          {/* Interview History */}
          {interviewHistory.length > 0 && (
            <div>
              <h2 className="text-2xl font-bold text-gray-900 mb-4">Recent Interviews</h2>
              <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                {interviewHistory.slice(-5).reverse().map((interview, idx) => (
                  <div key={idx} className="p-4 border-b border-gray-100 last:border-b-0">
                    <div className="flex items-center justify-between">
                      <div>
                        <h4 className="font-semibold text-gray-900">{interview.role}</h4>
                        <p className="text-sm text-gray-600">
                          {new Date(interview.date).toLocaleDateString()}
                        </p>
                      </div>
                      <div className="text-right">
                        <div className="text-2xl font-bold text-indigo-600">
                          {interview.overall}
                        </div>
                        <div className="text-xs text-gray-600">Overall Score</div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    );
  }

  // Interview View
  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50 flex flex-col">
      {/* Header */}
      <div className="bg-white border-b border-gray-200 p-4 shadow-sm">
        <div className="max-w-6xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-3">
            <button
              onClick={() => setCurrentView('home')}
              className="px-4 py-2 text-gray-600 hover:text-gray-900 font-medium"
            >
              ‚Üê Back
            </button>
            <div className={`p-2 ${selectedRole?.color} rounded-lg text-xl`}>
              {selectedRole?.icon}
            </div>
            <div>
              <h2 className="font-bold text-gray-900">{selectedRole?.name}</h2>
              <p className="text-sm text-gray-600">Question {questionCount}/5</p>
            </div>
          </div>
          
          <div className="flex gap-2">
            <div className="text-center px-3 py-1 bg-blue-50 rounded-lg">
              <div className="text-xs text-gray-600">Technical</div>
              <div className="font-bold text-blue-600">{interviewScore.technical}</div>
            </div>
            <div className="text-center px-3 py-1 bg-green-50 rounded-lg">
              <div className="text-xs text-gray-600">Behavioral</div>
              <div className="font-bold text-green-600">{interviewScore.behavioral}</div>
            </div>
            <div className="text-center px-3 py-1 bg-purple-50 rounded-lg">
              <div className="text-xs text-gray-600">Communication</div>
              <div className="font-bold text-purple-600">{interviewScore.communication}</div>
            </div>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="flex-1 overflow-hidden flex flex-col max-w-6xl mx-auto w-full p-4">
        {/* Conversation Area */}
        <div className="flex-1 bg-white rounded-xl shadow-sm border border-gray-200 mb-4 overflow-y-auto p-4">
          {conversation.map((msg, idx) => (
            <div
              key={idx}
              className={`mb-4 ${msg.role === 'user' ? 'text-right' : 'text-left'}`}
            >
              <div
                className={`inline-block max-w-[80%] p-4 rounded-2xl ${
                  msg.role === 'user'
                    ? 'bg-indigo-600 text-white'
                    : 'bg-gray-100 text-gray-900'
                }`}
              >
                <p className="whitespace-pre-wrap">{msg.content}</p>
                {msg.confidence && (
                  <div className="mt-2 pt-2 border-t border-indigo-400 text-xs">
                    <span>Confidence: {msg.confidence.confidenceScore}%</span>
                    <span className="ml-2">Pace: {msg.confidence.pace}</span>
                  </div>
                )}
              </div>
            </div>
          ))}
          
          {isProcessing && (
            <div className="text-center">
              <div className="inline-block p-3 bg-gray-100 rounded-lg">
                <div className="animate-pulse text-gray-600">AI is thinking...</div>
              </div>
            </div>
          )}
        </div>

        {/* Voice Confidence Indicator */}
        {voiceConfidence && (
          <div className="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-3 mb-4 border border-green-200">
            <div className="flex items-center justify-between text-sm">
              <div className="flex items-center gap-4">
                <div>
                  <span className="text-gray-600">Clarity:</span>
                  <span className="font-bold text-green-600 ml-1">{voiceConfidence.clarity}%</span>
                </div>
                <div>
                  <span className="text-gray-600">Pace:</span>
                  <span className="font-bold text-blue-600 ml-1 capitalize">{voiceConfidence.pace}</span>
                </div>
                <div>
                  <span className="text-gray-600">Words:</span>
                  <span className="font-bold text-purple-600 ml-1">{voiceConfidence.wordCount}</span>
                </div>
              </div>
              <div className="text-right">
                <div className="text-xs text-gray-600">Voice Confidence</div>
                <div className="text-xl font-bold text-indigo-600">{voiceConfidence.confidenceScore}%</div>
              </div>
            </div>
          </div>
        )}

        {/* Code Editor */}
        {codeEditorOpen && (
          <div className="bg-white rounded-xl shadow-lg border-2 border-indigo-600 p-4 mb-4">
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-bold text-gray-900">Code Editor</h3>
              <div className="flex gap-2">
                <select
                  value={codeLanguage}
                  onChange={(e) => setCodeLanguage(e.target.value)}
                  className="px-3 py-1 border border-gray-300 rounded-lg text-sm"
                >
                  <option value="javascript">JavaScript</option>
                  <option value="python">Python</option>
                </select>
                <button
                  onClick={runCode}
                  className="px-4 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium"
                >
                  Run Code
                </button>
                <button
                  onClick={() => setCodeEditorOpen(false)}
                  className="px-4 py-1 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm"
                >
                  Close
                </button>
              </div>
            </div>
            
            <textarea
              value={code}
              onChange={(e) => setCode(e.target.value)}
              className="w-full h-40 p-3 font-mono text-sm border border-gray-300 rounded-lg mb-2 bg-gray-50"
              placeholder="Write your code here..."
            />
            
            {codeOutput && (
              <div className="bg-black text-green-400 p-3 rounded-lg font-mono text-sm whitespace-pre-wrap">
                {codeOutput}
              </div>
            )}
          </div>
        )}

        {/* Input Area */}
        <div className="bg-white rounded-xl shadow-lg border-2 border-gray-200 p-4">
          <div className="flex items-center gap-2 mb-3">
            <button
              onClick={() => setCodeEditorOpen(!codeEditorOpen)}
              className="p-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
              title="Open Code Editor"
            >
              <Code className="w-5 h-5 text-gray-700" />
            </button>
            
            <div className="flex-1 relative">
              <textarea
                value={transcript}
                onChange={(e) => setTranscript(e.target.value)}
                placeholder="Your answer will appear here... Click the mic to speak or type your response"
                className="w-full p-3 pr-12 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-indigo-600"
                rows="2"
              />
              {isSpeaking && (
                <Volume2 className="absolute right-3 top-3 w-5 h-5 text-indigo-600 animate-pulse" />
              )}
            </div>
            
            <button
              onClick={isListening ? stopListening : startListening}
              className={`p-3 rounded-lg transition-all ${
                isListening
                  ? 'bg-red-600 hover:bg-red-700 text-white animate-pulse'
                  : 'bg-indigo-600 hover:bg-indigo-700 text-white'
              }`}
            >
              {isListening ? <MicOff className="w-5 h-5" /> : <Mic className="w-5 h-5" />}
            </button>
            
            <button
              onClick={handleSendMessage}
              disabled={!transcript.trim() || isProcessing}
              className="p-3 bg-green-600 hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-lg transition-colors"
            >
              <Send className="w-5 h-5" />
            </button>
          </div>
          
          <div className="flex items-center justify-between text-xs text-gray-500">
            <span>
              {isListening ? 'üî¥ Listening...' : 'üé§ Click mic to start speaking'}
            </span>
            <span>{transcript.length} characters</span>
          </div>
        </div>
      </div>
    </div>
  );
};

export default InterviewCoach;
